Backport of:

From 805850d4b67eff263a8dab0999ab59e6243534f1 Mon Sep 17 00:00:00 2001
From: Aaron Haslett <aaronhaslett@catalyst.net.nz>
Date: Tue, 23 Oct 2018 17:25:51 +1300
Subject: [PATCH 5/5] CVE-2018-14629 dns: CNAME loop prevention using counter

Count number of answers generated by internal DNS query routine and stop at
20 to match Microsoft's loop prevention mechanism.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=13600

Signed-off-by: Aaron Haslett <aaronhaslett@catalyst.net.nz>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
Reviewed-by: Garming Sam <garming@catalyst.net.nz>
diff --git a/source4/dns_server/dns_query.c b/source4/dns_server/dns_query.c
index f730a70..6e67276 100644
--- a/source4/dns_server/dns_query.c
+++ b/source4/dns_server/dns_query.c
@@ -29,6 +29,8 @@
 #include "dsdb/common/util.h"
 #include "dns_server/dns_server.h"
 
+#define MAX_Q_RECURSION_DEPTH 20
+
 static WERROR handle_question(struct dns_server *dns,
 			      TALLOC_CTX *mem_ctx,
 			      const struct dns_name_question *question,
@@ -45,6 +47,10 @@ static WERROR handle_question(struct dns_server *dns,
 	struct dnsp_DnssrvRpcRecord *recs;
 	struct ldb_message_element *el;
 
+	if (talloc_array_length(*answers) >= MAX_Q_RECURSION_DEPTH) {
+		return WERR_OK;
+	}
+
 	werror = dns_name2dn(dns, mem_ctx, question->name, &dn);
 	W_ERROR_NOT_OK_RETURN(werror);
 
