Backport of:

From 03dc463f3274204aba9f8bb018cf85d1b27d070d Mon Sep 17 00:00:00 2001
From: Isaac Boukris <iboukris@gmail.com>
Date: Wed, 30 Jan 2019 23:49:07 +0200
Subject: [PATCH 2/2] CVE-2018-16860 Heimdal KDC: Reject PA-S4U2Self with
 unkeyed checksum

BUG: https://bugzilla.samba.org/show_bug.cgi?id=13685

Signed-off-by: Isaac Boukris <iboukris@gmail.com>
Reviewed-by: Andrew Bartlett <abartlet@samba.org>
Signed-off-by: Andrew Bartlett <abartlet@samba.org>
---
 selftest/knownfail.d/mitm-s4u2self | 576 -------------------------------------
 source4/heimdal/kdc/krb5tgs.c      |   7 +
 2 files changed, 7 insertions(+), 576 deletions(-)
 delete mode 100644 selftest/knownfail.d/mitm-s4u2self

Index: samba-3.6.25/source4/heimdal/kdc/krb5tgs.c
===================================================================
--- samba-3.6.25.orig/source4/heimdal/kdc/krb5tgs.c
+++ samba-3.6.25/source4/heimdal/kdc/krb5tgs.c
@@ -1843,6 +1843,13 @@ server_lookup:
 		goto out;
 	    }
 
+	    if (!krb5_checksum_is_keyed(context, self.cksum.cksumtype)) {
+		free_PA_S4U2Self(&self);
+		kdc_log(context, config, 0, "Reject PA-S4U2Self with unkeyed checksum");
+		ret = KRB5KRB_AP_ERR_INAPP_CKSUM;
+		goto out;
+	    }
+
 	    ret = _krb5_s4u2self_to_checksumdata(context, &self, &datack);
 	    if (ret)
 		goto out;
